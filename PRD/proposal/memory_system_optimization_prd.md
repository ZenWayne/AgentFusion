# MemoryContext éœ€æ±‚æ–‡æ¡£

## æ–‡æ¡£ä¿¡æ¯
- **ç‰ˆæœ¬**: 1.0
- **æ—¥æœŸ**: 2026-02-10
- **çŠ¶æ€**: è‰æ¡ˆ

### æ–‡æ¡£åˆ†å·¥è¯´æ˜

| æ–‡æ¡£ | èŒè´£èŒƒå›´ | é“¾æ¥ |
|------|----------|------|
| **æœ¬æ–‡æ¡£** | MemoryContext éœ€æ±‚ã€æ¶æ„æµç¨‹ã€ä¸ä¸Šä¸‹æ¸¸äº¤äº’æ¥å£ | - |
| Memory Data Layer PRD | æ•°æ®è¡¨ Schemaã€æœç´¢ç®—æ³•å®ç°ï¼ˆè¯­ä¹‰/å…³é”®è¯/æ··åˆæœç´¢ï¼‰| [æŸ¥çœ‹](./memory_data_layer_prd.md) |
| MemRecallAgent Tools | å·¥å…·å‡½æ•°ç­¾åã€Pydantic è¾“å…¥è¾“å‡ºæ¨¡å‹ | [æŸ¥çœ‹](./memrecall_agent_tools.md) |
| MemRecallAgent Implementation | MemRecallAgent ç±»å®ç°ã€å·¥ä½œæ¨¡å¼ã€å†…éƒ¨é€»è¾‘ | [æŸ¥çœ‹](./memrecall_agent_implementation.md) |

**åŸåˆ™**: æœ¬æ–‡æ¡£ä¸é‡å¤æè¿°å…¶ä»–æ–‡æ¡£å·²å®šä¹‰çš„å†…å®¹ï¼Œä»…å¼•ç”¨å…¶æ¥å£ã€‚

---

## 1. èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 å½“å‰é—®é¢˜
- **æœç´¢èƒ½åŠ›å±€é™**: ä»…æ”¯æŒ SQL `ILIKE` å­ä¸²åŒ¹é…ï¼Œæ— å‘é‡ç›¸ä¼¼åº¦ï¼Œæ— æ³•è¯­ä¹‰ç†è§£
- **æŸ¥è¯¢æœºåˆ¶åƒµåŒ–**: `init_memory()` ä¸€æ¬¡æ€§ç”ŸæˆæŸ¥è¯¢ï¼Œå¯¹è¯ä¸­æ— æ³•åŠ¨æ€æœç´¢
- **å…³é”®è¯ç®¡ç†ç¼ºå¤±**: æ— å…³é”®è¯æå–å’Œç´¢å¼•æœºåˆ¶

### 1.2 ç›®æ ‡
1. **åŠ¨æ€è®°å¿†å¬å›**: å¯¹è¯åˆå§‹åŒ– + ä¸» Agent è°ƒç”¨ LLM å‰è‡ªåŠ¨è§¦å‘è®°å¿†æœç´¢
2. **å¢å¼ºæœç´¢èƒ½åŠ›**: è¯­ä¹‰ + å…³é”®è¯ + æ··åˆæœç´¢ï¼ˆä¾èµ– Data Layer å®ç°ï¼‰
3. **èŒè´£åˆ†ç¦»**: MemoryContext ç®¡çŠ¶æ€åè°ƒï¼ŒMemRecallAgent ç®¡æœç´¢æ‰§è¡Œ

### 1.3 éç›®æ ‡
- å‘é‡æ•°æ®åº“å®ç°ï¼ˆä¿ç•™ç»™åç»­è¿­ä»£ï¼‰
- è·¨ç”¨æˆ·è®°å¿†å…±äº«
- è®°å¿†è‡ªåŠ¨åˆå¹¶æŠ½è±¡

---

## 2. æ¶æ„è®¾è®¡

### 2.1 ç»„ä»¶å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä¸» Agent                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æ¥æ”¶ç”¨æˆ·æ¶ˆæ¯ â†’ å†³ç­– â†’ get_messages() â†’ è°ƒç”¨ LLM      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ è°ƒç”¨ get_messages() æ—¶è§¦å‘
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   MemoryContext                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  init_memory()    - å¯¹è¯åˆå§‹åŒ–æ—¶å¬å›                  â”‚  â”‚
â”‚  â”‚  get_messages()   - åŠ¨æ€å¬å›ï¼Œè¿”å›å¸¦è®°å¿†çš„æ¶ˆæ¯åˆ—è¡¨    â”‚  â”‚
â”‚  â”‚  add_message()    - å­˜å‚¨æ¶ˆæ¯åˆ°ç¼“å†²åŒº                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ å§”æ‰˜
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   MemRecallAgent                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  åˆ†ææ¶ˆæ¯ â†’ ç”Ÿæˆæœç´¢å‚æ•° â†’ è°ƒç”¨å·¥å…· â†’ è¿”å›ç»“æœ        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ è°ƒç”¨
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Data Layer                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  search_memories_advanced()                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 èŒè´£è¾¹ç•Œ

| ç»„ä»¶ | è´Ÿè´£ | ä¸è´Ÿè´£ |
|------|------|--------|
| **MemoryContext** | ç®¡ç†è®°å¿†çŠ¶æ€ã€åè°ƒå¬å›æ—¶æœºã€æ³¨å…¥ç³»ç»Ÿæ¶ˆæ¯ | å…·ä½“æœç´¢é€»è¾‘ã€å…³é”®è¯æå– |
| **MemRecallAgent** | åˆ†ææ„å›¾ã€ç”Ÿæˆæœç´¢å‚æ•°ã€è°ƒç”¨å·¥å…·æœç´¢ã€æ ¼å¼åŒ–ç»“æœ | æ‰§è¡Œç”¨æˆ·å‘½ä»¤ã€ç”Ÿæˆæœ€ç»ˆå›å¤ |
| **ä¸» Agent** | ä¸šåŠ¡å†³ç­–ã€æ‰§è¡Œå‘½ä»¤ã€ç”Ÿæˆå›å¤ | è®°å¿†æœç´¢ |

---

## 3. MemoryContext éœ€æ±‚

### 3.1 åŠŸèƒ½éœ€æ±‚

#### FR1: å¯¹è¯åˆå§‹åŒ–å¬å›
- **è§¦å‘æ—¶æœº**: ç”¨æˆ·å¼€å§‹æ–°å¯¹è¯
- **è¡Œä¸º**: è°ƒç”¨ MemRecallAgent åˆ†æåˆå§‹æ¶ˆæ¯ï¼Œå¦‚æœ‰ç›¸å…³è®°å¿†åˆ™æ³¨å…¥ç³»ç»Ÿæ¶ˆæ¯
- **è¾“å…¥**: ç”¨æˆ·åˆå§‹æ¶ˆæ¯
- **è¾“å‡º**: åŒ…å«è®°å¿†ä¸Šä¸‹æ–‡çš„ç³»ç»Ÿæ¶ˆæ¯åˆ—è¡¨ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰

#### FR2: åŠ¨æ€è®°å¿†å¬å›
- **è§¦å‘æ—¶æœº**: ä¸» Agent è°ƒç”¨ `get_messages()` å‡†å¤‡å‘é€ç»™ LLM å‰
- **è¡Œä¸º**:
  1. å°†å½“å‰æ¶ˆæ¯åˆ—è¡¨ä¼ ç»™ MemRecallAgent
  2. MemRecallAgent åˆ†ææ˜¯å¦éœ€è¦å¬å›
  3. å¦‚æœ‰æ–°è®°å¿†ï¼Œæ›´æ–°ç³»ç»Ÿæ¶ˆæ¯
- **è¾“å…¥**: å½“å‰å¯¹è¯æ¶ˆæ¯åˆ—è¡¨
- **è¾“å‡º**: [è®°å¿†ç³»ç»Ÿæ¶ˆæ¯] + [å¯¹è¯å†å²æ¶ˆæ¯]

#### FR3: è®°å¿†çŠ¶æ€ç®¡ç†
- å­˜å‚¨å·²å¬å›çš„è®°å¿†åˆ—è¡¨
- ç»´æŠ¤è®°å¿†ç³»ç»Ÿæ¶ˆæ¯
- å¯¹è¯ç»“æŸæ—¶æ¸…ç†çŠ¶æ€

### 3.2 æ¥å£å®šä¹‰

```python
class MemoryContext(ChatCompletionContext):
    def __init__(
        self,
        *,
        data_layer: AgentFusionDataLayer,
        user_id: int,
        memory_model_client: ChatCompletionClient,
    ):
        """
        Args:
            data_layer: æ•°æ®å±‚è®¿é—®æ¥å£ï¼ˆç”¨äºåˆå§‹åŒ– MemRecallAgentï¼‰
            user_id: å½“å‰ç”¨æˆ· IDï¼ˆæ•°æ®éš”ç¦»ï¼‰
            memory_model_client: ç”¨äºè®°å¿†å¬å›çš„ LLM å®¢æˆ·ç«¯
        """

    async def init_memory(self, user_message: str) -> List[LLMMessage]:
        """
        å¯¹è¯åˆå§‹åŒ–æ—¶çš„è®°å¿†å¬å›

        æµç¨‹:
        1. è°ƒç”¨ MemRecallAgent.recall_and_format(user_message)
        2. å¦‚æœ‰ç»“æœï¼Œæ„å»ºè®°å¿†ç³»ç»Ÿæ¶ˆæ¯
        3. è¿”å›ç³»ç»Ÿæ¶ˆæ¯åˆ—è¡¨
        """

    async def get_messages(self) -> List[LLMMessage]:
        """
        è·å–åŒ…å«è®°å¿†ä¸Šä¸‹æ–‡çš„å®Œæ•´æ¶ˆæ¯åˆ—è¡¨

        è§¦å‘æ—¶æœº: ä¸» Agent è°ƒç”¨ LLM å‰

        æµç¨‹:
        1. è°ƒç”¨ MemRecallAgent.recall_with_context(messages)
        2. å¦‚æœ‰æ–°è®°å¿†ï¼Œæ›´æ–°ç³»ç»Ÿæ¶ˆæ¯
        3. è¿”å› [è®°å¿†ç³»ç»Ÿæ¶ˆæ¯] + [å¯¹è¯å†å²]
        """

    async def add_message(self, message: LLMMessage) -> None:
        """æ·»åŠ æ¶ˆæ¯åˆ°å†…éƒ¨ç¼“å†²åŒº"""

    def clear_memory_context(self) -> None:
        """æ¸…é™¤è®°å¿†ä¸Šä¸‹æ–‡ï¼ˆå¯¹è¯ç»“æŸæ—¶è°ƒç”¨ï¼‰"""
```

### 3.3 ä¸ MemRecallAgent åä½œ

MemoryContext é€šè¿‡ä»¥ä¸‹æ¥å£è°ƒç”¨ MemRecallAgent:

```python
# åˆå§‹åŒ–å¬å›
result = await self.recall_agent.recall_and_format(user_message)

# åŠ¨æ€å¬å›
result = await self.recall_agent.recall_with_context(messages)

# è¿”å›ç»“æœç±»å‹: MemRecallResultï¼ˆå®šä¹‰è§ memrecall_agent_tools.mdï¼‰
class MemRecallResult(BaseModel):
    action: Literal["RECALL_SUCCESS", "NO_RELEVANT_MEMORY"]
    formatted_context: str  # æ ¼å¼åŒ–åçš„è®°å¿†æ–‡æœ¬
    memories: List[MemorySearchResultItem]
    confidence: float
```

---

## 4. æµç¨‹å›¾

### 4.1 å®Œæ•´äº¤äº’æµç¨‹

```mermaid
flowchart TB
    subgraph INIT["ğŸš€ é˜¶æ®µä¸€ï¼šå¯¹è¯åˆå§‹åŒ–"]
        A[ç”¨æˆ·å¼€å§‹æ–°å¯¹è¯] --> B[åˆ›å»º/åŠ è½½å¯¹è¯çº¿ç¨‹]
        B --> C[åˆå§‹åŒ– MemoryContext]
        C --> D[è°ƒç”¨ init_memory]
        D --> D1[MemRecallAgent<br/>recall_and_format]
        D1 --> D2{æ‰¾åˆ°è®°å¿†?}
        D2 -->|æ˜¯| D3[æ„å»ºè®°å¿†ç³»ç»Ÿæ¶ˆæ¯<br/>æ³¨å…¥ä¸Šä¸‹æ–‡]
        D2 -->|å¦| D4[è¿”å›ç©º]
        D3 --> E[ç­‰å¾…ç”¨æˆ·è¾“å…¥]
        D4 --> E
    end

    subgraph MSGLOOP["ğŸ’¬ é˜¶æ®µäºŒï¼šæ¶ˆæ¯å¤„ç†å¾ªç¯"]
        E --> F[æ¥æ”¶ç”¨æˆ·æ¶ˆæ¯]
        F --> G[ä¸» Agent å†³ç­–]

        G -->|æ‰§è¡Œæ„å›¾| H1[è°ƒç”¨æ‰§è¡Œå·¥å…·<br/>å¦‚ transfer_to_console]
        G -->|éœ€ LLM å›å¤| H2[è°ƒç”¨ get_messages]

        H1 --> I[è¿”å›æ‰§è¡Œç»“æœ]
        H2 --> H3[MemoryContext<br/>è§¦å‘åŠ¨æ€å¬å›]
        H3 --> H4{éœ€è¦å¬å›?}
        H4 -->|æ˜¯| H5[MemRecallAgent<br/>recall_with_context]
        H4 -->|å¦| H6[è¿”å›å½“å‰ä¸Šä¸‹æ–‡]
        H5 --> H7[æ›´æ–°è®°å¿†ç³»ç»Ÿæ¶ˆæ¯]
        H7 --> H8[è¿”å›å®Œæ•´æ¶ˆæ¯åˆ—è¡¨]
        H6 --> H8
        H8 --> I

        I --> J[ä¸» Agent ç”Ÿæˆå›å¤]
        J --> K{å¯¹è¯ç»“æŸ?}
        K -->|å¦| F
        K -->|æ˜¯| L[ä¿å­˜å¯¹è¯è®°å¿†]
    end

    subgraph RECALL["ğŸ” MemRecallAgent å†…éƒ¨"]
        D1 --> R1[åˆ†æç”¨æˆ·æ¶ˆæ¯]
        R1 --> R2[ç”Ÿæˆæœç´¢å‚æ•°]
        R2 --> R3[è°ƒç”¨ search_memories]
        R3 --> R4{éœ€è¦å®Œæ•´å†…å®¹?}
        R4 -->|æ˜¯| R5[è°ƒç”¨ get_memory_detail]
        R4 -->|å¦| R6[æ ¼å¼åŒ–ç»“æœ]
        R5 --> R6
        R6 --> R7[è¿”å› formatted_context]

        H5 --> R8[åˆ†ææ¶ˆæ¯åˆ—è¡¨<br/>åˆ¤æ–­æ˜¯å¦éœ€è¦å¬å›]
        R8 --> R9{éœ€è¦å¬å›?}
        R9 -->|æ˜¯| R2
        R9 -->|å¦| R10[è¿”å›ç©ºç»“æœ]
    end

    style INIT fill:#e1f5ff
    style MSGLOOP fill:#fff3e0
    style RECALL fill:#f3e5f5
```

### 4.2 å…³é”®æµç¨‹è¯´æ˜

#### æµç¨‹ 1ï¼šåˆå§‹åŒ–å¬å›
```
è§¦å‘: ç”¨æˆ·å¼€å§‹æ–°å¯¹è¯
è°ƒç”¨: MemoryContext.init_memory(user_message)

1. è°ƒç”¨ MemRecallAgent.recall_and_format()
2. MemRecallAgent åˆ†æ â†’ æœç´¢ â†’ æ ¼å¼åŒ–
3. MemoryContext å°† formatted_context åŒ…è£…ä¸ºç³»ç»Ÿæ¶ˆæ¯
4. è¿”å›ç³»ç»Ÿæ¶ˆæ¯ï¼ˆä½œä¸ºä¸» Agent çš„ system messageï¼‰
```

#### æµç¨‹ 2ï¼šåŠ¨æ€å¬å›
```
è§¦å‘: ä¸» Agent å‡†å¤‡è°ƒç”¨ LLM å‰
è°ƒç”¨: MemoryContext.get_messages()

1. MemoryContext å°†æ¶ˆæ¯åˆ—è¡¨ä¼ ç»™ MemRecallAgent
2. MemRecallAgent.recall_with_context() åˆ†ææ˜¯å¦éœ€è¦å¬å›
3. å¦‚éœ€è¦ï¼Œæ‰§è¡Œæœç´¢å¹¶è¿”å› formatted_context
4. MemoryContext æ›´æ–°è®°å¿†ç³»ç»Ÿæ¶ˆæ¯
5. è¿”å› [è®°å¿†ç³»ç»Ÿæ¶ˆæ¯] + [å¯¹è¯å†å²]
```

---

## 5. è®°å¿†ç³»ç»Ÿæ¶ˆæ¯æ ¼å¼

### 5.1 ç³»ç»Ÿæ¶ˆæ¯ç»“æ„

MemoryContext æ„å»ºçš„ç³»ç»Ÿæ¶ˆæ¯ï¼š

```markdown
## å†å²è®°å¿†ä¸Šä¸‹æ–‡

ä»¥ä¸‹æ˜¯æ ¹æ®ç”¨æˆ·å½“å‰é—®é¢˜å¬å›çš„ç›¸å…³å†å²è®°å¿†ã€‚è¯·åœ¨å›å¤æ—¶å‚è€ƒè¿™äº›ä¿¡æ¯ï¼š

{formatted_context}

---

## è®°å¿†ä½¿ç”¨æŒ‡å—

1. **å‘½ä»¤ç±»è®°å¿†**: å¦‚æœç”¨æˆ·è¦æ±‚"é‡æ–°æ‰§è¡Œ"ã€"å†æ¬¡è¿è¡Œ"ç­‰ï¼Œä½¿ç”¨è®°å¿†ä¸­çš„å®Œæ•´å‘½ä»¤
2. **ä¿¡æ¯ç±»è®°å¿†**: åŸºäºè®°å¿†ä¸­çš„ä¿¡æ¯å›ç­”ç”¨æˆ·é—®é¢˜
3. **æ— ç›¸å…³è®°å¿†**: å¦‚æœè®°å¿†ä¸è¶³ä»¥å›ç­”ç”¨æˆ·ï¼Œæ­£å¸¸å¯¹è¯å³å¯

æœç´¢æ‘˜è¦: {search_summary}
```

### 5.2 formatted_context ç¤ºä¾‹

ç”± MemRecallAgent ç”Ÿæˆï¼ŒMemoryContext ç›´æ¥åµŒå…¥ï¼š

```markdown
### å†å²å‘½ä»¤ [cmd-001]
å‘½ä»¤: python train.py --epochs 100 --batch-size 32
æ‘˜è¦: è®­ç»ƒ ResNet50 æ¨¡å‹

### å†å²è®°å¿† [db-config-001]
æ‘˜è¦: MySQL ä¸»ä»é…ç½®
å†…å®¹: server-id=1, port=3306, master-host=192.168.1.100...
```

---

## 6. ä¾èµ–æ¥å£

### 6.1 ä¾èµ– MemRecallAgent

å®šä¹‰è§ [memrecall_agent_implementation.md](./memrecall_agent_implementation.md)ï¼š

```python
class MemRecallAgent:
    async def recall_and_format(self, user_message: str) -> MemRecallResult
    async def recall_with_context(self, messages: List[LLMMessage]) -> MemRecallResult
```

### 6.2 ä¾èµ– Data Layer

å®šä¹‰è§ [memory_data_layer_prd.md](./memory_data_layer_prd.md)ï¼š

```python
class MemoryModel:
    async def search_memories_advanced(
        self,
        user_id: int,
        query: str,
        keywords: Optional[List[str]],
        search_mode: Literal["semantic", "keyword", "hybrid"],
        ...
    ) -> List[MemorySearchResult]
```

### 6.3 ä¾èµ–å·¥å…·æ¨¡å‹

å®šä¹‰è§ [memrecall_agent_tools.md](./memrecall_agent_tools.md)ï¼š

- `MemRecallResult` - MemRecallAgent è¿”å›ç»“æœ
- `MemorySearchResultItem` - å•æ¡è®°å¿†ç»“æœ

---

## 7. å®ç°è®¡åˆ’

### é˜¶æ®µä¸€ï¼šMemoryContext åŸºç¡€
- [ ] å®ç° `MemoryContext` ç±»ç»§æ‰¿ `ChatCompletionContext`
- [ ] å®ç° `init_memory()` åˆå§‹åŒ–å¬å›
- [ ] å®ç° `get_messages()` åŠ¨æ€å¬å›è§¦å‘
- [ ] å®ç°è®°å¿†çŠ¶æ€ç®¡ç†

### é˜¶æ®µäºŒï¼šé›†æˆ MemRecallAgent
- [ ] é›†æˆ `MemRecallAgent` ä½œä¸ºå­ç»„ä»¶
- [ ] å®ç° `init_memory()` è°ƒç”¨ `recall_and_format()`
- [ ] å®ç° `get_messages()` è°ƒç”¨ `recall_with_context()`

### é˜¶æ®µä¸‰ï¼šä¸ä¸» Agent é›†æˆ
- [ ] ä¸» Agent ä½¿ç”¨ `MemoryContext` æ›¿ä»£æ™®é€š `ChatCompletionContext`
- [ ] æµ‹è¯•å®Œæ•´äº¤äº’æµç¨‹

### é˜¶æ®µå››ï¼šæµ‹è¯•
- [ ] å•å…ƒæµ‹è¯•ï¼šMemoryContext å„æ–¹æ³•
- [ ] é›†æˆæµ‹è¯•ï¼šMemoryContext + MemRecallAgent + Data Layer
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•ï¼šå®Œæ•´å¯¹è¯æµç¨‹

---

## 8. é™„å½•ï¼šç›¸å…³æ–‡æ¡£ç´¢å¼•

| æ–‡æ¡£ | å…³é”®å†…å®¹ | ç« èŠ‚ |
|------|----------|------|
| [memory_data_layer_prd.md](./memory_data_layer_prd.md) | æ•°æ®è¡¨ Schemaã€æœç´¢ç®—æ³• | ç¬¬ 2 èŠ‚ã€ç¬¬ 4 èŠ‚ |
| [memrecall_agent_tools.md](./memrecall_agent_tools.md) | å·¥å…·è¾“å…¥è¾“å‡ºæ¨¡å‹ | ç¬¬ 2 èŠ‚ã€ç¬¬ 8 èŠ‚ |
| [memrecall_agent_implementation.md](./memrecall_agent_implementation.md) | MemRecallAgent ç±»ã€å·¥ä½œæ¨¡å¼ | ç¬¬ 2 èŠ‚ã€ç¬¬ 2.4 èŠ‚ |
